(function(){$(function(){var e,t,n,r,i,s,o,u,a;n=$("#search"),i=$("#search-bar"),t=getCookie("csrftoken")||window.csrf_token,e=new CanvasLoader("search-canvasloader-container"),e.setColor("#3ebac2"),e.setShape("rect"),e.setDiameter(22),e.setDensity(43),e.setRange(1.2),e.setFPS(22),u={community:gettext("Communities"),need:gettext("Needs"),organization:gettext("Organizations"),resource:gettext("Resources"),investiment:gettext("Investments"),google:gettext("Google Results"),user:gettext("User"),project:gettext("Project")},s=function(){return $("#search-results-box").popover("show"),$(".popover").css("top",parseInt($(".popover").css("top"),10)-10),$(".popover").css("left",parseInt($(".popover").css("left"),10)-75)},window.seeOnMap=function(e){var t,n;return window.location.pathname===dutils.urls.resolve("map")?(e[0]==="g"?(t=parseInt(e.substring(1,e.length),10),n=setInterval(function(){var e;try{return e=JSON.parse(localStorageGet("komoo_search").results.google).predictions[t].description,editor.goTo(e),clearInterval(n)}catch(r){}},500)):$.get("/map/get_geojson_from_hashlink/",{hashlink:e},function(e){var t;return t=JSON.parse(e.geojson),n=setInterval(function(){try{return editor.loadGeoJSON(t,!0),clearInterval(n)}catch(e){}},500)},"json"),$("#search-results-box").popover("hide")):window.location=dutils.urls.resolve("map")+("#"+e)},o=function(t){var n,r,i,o,a,f,l,c,h,p,d,v,m,g,y,b,w,E;d="",p=0,o=!1,h=["community","project","organization","need","resource","user"];for(m=0,y=h.length;m<y;m++){l=h[m],v=t[l];if((v!=null?v.length:void 0)&&l!=="google"){d+="<li>\n<div class='search-header "+l+"' >\n    <img src='/static/img/"+l+".png' >\n    <div class='search-type-header' >\n        "+u[l]+"\n        <span class='search-results-count'>\n            "+interpolate(ngettext("%s result","%s results",v.length),[v.length])+"\n        </span>\n    </div>\n</div>\n<ul class='search-result-entries'>";for(f in v){c=v[f],r=(c!=null?!c.has_geojson:!void 0)?"disabled":"",a=l[0]+c.id,d+='<li class="search-result">\n    <a class="search-result-title" href=\''+c.link+"'> "+c.name+' </a>\n    <div class="right">\n        <a href="/map/#'+a+'" hashlink="'+a+'" class="search-map-link '+r+'"><i class="icon-see-on-map"></i></a>\n    </div>\n</li>';if(l==="organization"&&((w=c.branches)!=null?w.length:void 0)){E=c.branches;for(g=0,b=E.length;g<b;g++)n=E[g],d+='<li class="branch-search-result">\n    <span class="search-result-title org-branch">&#8226; '+n.name+'</span>\n    <div class="right">\n        <a href="/map/#b'+n.id+'" hashlink="b'+n.id+'" class="search-map-link"><i class="icon-see-on-map"></i></a>\n    </div>\n</li>'}p++}d+="</ul></li>",o|=!0}else o|=!1}i=JSON.parse(t.google).predictions;if(i!=null?i.length:void 0){l="google",d+='<li>\n<div class="search-header google">\n    <img src="/static/img/'+l+'.png" >\n    <div class="search-type-header" >\n        '+u[l]+'\n        <span class="search-results-count">\n            '+interpolate(ngettext("%s result","%s results",i.length),[i.length])+'\n        </span>\n    </div>\n</div>\n<ul class="search-result-entries">';for(f in i)c=i[f],a="g"+f,d+='<li>\n    <a href="#" class="search-result-title"> '+c.description+'</a>\n    <div class="right">\n        <a href="#'+a+'" hashlink="'+a+'" class="search-map-link"><i class="icon-see-on-map"></i></a>\n    </div>\n</li>',p++;d+="</ul></li>",o|=!0}else o|=!1;return o||(d='<div class="search-no-results"> '+gettext("No results found!")+"</div>"),$("#search-results-box").data("popover").options.title=""+p+' Results <span id="search-box-close" >x</span>',$("#search-results-box").data("popover").options.content=d,s(),e.hide()},n.submit(function(n){var r,s;n.preventDefault(),s=i.val(),r=localStorageGet("komoo_search");if(!s)return;return e.show(),(r!=null?r.term:void 0)===s?o(r.results):$.ajax({type:"POST",url:dutils.urls.resolve("komoo_search"),data:{term:s,csrfmiddlewaretoken:t},dataType:"json",success:function(e){return localStorageSet("komoo_search",{term:s,results:e.result}),o(e.result)}})}),$("#search-results-box").popover({placement:"bottom",selector:i,trigger:"manual"}),$("#search-box-close").live("click",function(){return $("#search-results-box").popover("hide")}),$(".search-map-link").live("click",function(e){var t;return e.preventDefault(),t=$(this),t.is(".disabled")?!1:seeOnMap(t.attr("hashlink"))}),i.val(((a=localStorageGet("komoo_search"))!=null?a.term:void 0)||"");if(window.location.pathname===dutils.urls.resolve("map")){r=window.location.hash;if(r)return seeOnMap(r.substring(1,r.length))}})}).call(this);